<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soccer Configuration Generator - Phaser</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">

<script>
    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 0 },
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    let fieldInPixel = {
        x_min : 100,
        y_min : 100,
        x_max : 1250,
        y_max : 850
    }

    const game = new Phaser.Game(config);
    let line;
    let playersGroup;
    let circleGraphics;
    let ballGraphics;
    let lineGraphics;

    let myTeam;
    let indexBH;

    function preload() {
        // Load PNG image (replace placeholder URL)
        this.load.image('background', 'field.png');
        this.load.image('soccerBall', 'textures-ball.png')
        this.load.image('player1', 'robot1.png');
        this.load.image('player2', 'robot2.png');

    }

    function generateScene(scene, playersGroup){

        if (lineGraphics) lineGraphics.destroy();
        if (circleGraphics) circleGraphics.destroy();
        if (ballGraphics) ballGraphics.destroy();

        createPlayers('team1');
        createPlayers('team2');
        
        lineGraphics = scene.add.graphics();
        circleGraphics = scene.add.graphics();
        ballGraphics = scene.add.graphics();
        ballGraphics.fillStyle(0xffffff);
        lineGraphics.lineStyle(2, 0xffffff);

        myTeam = playersGroup.getChildren().filter(player => player.team === 'team1');
        indexBH = Math.floor(Math.random() * 6)

        ballGraphics.fillCircle(myTeam[indexBH].x+Math.cos(myTeam[indexBH].rotation)*25, myTeam[indexBH].y+Math.sin(myTeam[indexBH].rotation)*25, 15);

        line = new Phaser.Geom.Line(myTeam[indexBH].x, myTeam[indexBH].y, myTeam[indexBH].x, myTeam[indexBH].y);
        lineGraphics.strokeLineShape(line);

    }

    function isInsideField(x,y){
        return x >= fieldInPixel.x_min && x <= fieldInPixel.x_max && y > fieldInPixel.y_min && y < fieldInPixel.y_max
    }

    function create() {
        // Create a sprite with the loaded PNG image
        const background = this.add.image(0, 0, 'background').setOrigin(0);

        background.displayHeight = window.innerHeight
        background.scaleX = background.scaleY;

        fieldInPixel.h = background.displayHeight
        fieldInPixel.w = background.displayWidth


        // Create a group to hold players
        playersGroup = this.physics.add.group();

        generateScene(this, playersGroup)

        const button = this.add.text(
            window.innerWidth*0.98, // X position
            window.innerHeight*0.4, // Y position
            'No\nPassage', // Text content
            { fontSize: '100px', fill: '#fff', backgroundColor: '#f00', align: 'center'} // Text style
        ).setOrigin(1, 0).setInteractive();

        
        // Set up input event for player selection
        this.input.on('gameobjectdown', (pointer, gameObject) => {
            if (gameObject instanceof Phaser.GameObjects.Sprite){
                if (!selectionCheck(gameObject))
                    return;
                suggestPass(gameObject);
            }
            else if( gameObject instanceof Phaser.GameObjects.Text ){
                suggestNoPass('Button clicked!');
            }
            playersGroup.clear(true, true);
            this.input.setDefaultCursor('auto');
            this.input.activePointer.cursorIndex = -1;
            generateScene(this, playersGroup)
        });

        this.input.on('gameobjectover', function (pointer, gameObject) {
            console.log(gameObject)
            if (gameObject instanceof Phaser.GameObjects.Sprite || gameObject instanceof Phaser.GameObjects.Text) {
                // Use the system's default pointer cursor
                this.input.setDefaultCursor('pointer');
                this.input.activePointer.cursorIndex = gameObject.index;
            }
        }, this);

        this.input.on('gameobjectout', function () {
            // Reset cursor to the default
            this.input.setDefaultCursor('auto');
            this.input.activePointer.cursorIndex = -1;
        }, this);
    }

    function createPlayers(team) {
        for (let i = 1; i <= 6; i++) {
            img = team == "team1" ? "player1" : "player2"
            // 100 to 1250
            x = Math.random() * (fieldInPixel.x_max - fieldInPixel.x_min) + fieldInPixel.x_min;
            y = Math.random() * (fieldInPixel.y_max - fieldInPixel.y_min) + fieldInPixel.y_min;
            const player = playersGroup.create(x, y, img).setInteractive();
            player.rotation = Math.random() * (2 * Math.PI);
            player.setCircle(16, 0, 0); // Set player as a circle
            player.team = team;
            player.playerNumber = i;
            player.setScale(0.2);
        }
    }

    function suggestPass(player) {
        console.log(`Suggest a pass from ${player.team} - Player ${player.playerNumber}`);
    }

    function suggestNoPass() {
        console.log('No pass!')
    }

    function selectionCheck(player) {
        return player.team == "team1" && player != myTeam[indexBH]
    }

    function update() {
        // Clear the graphics before drawing new circles
        circleGraphics.clear();
        lineGraphics.clear();


        // Get the mouse pointer
        const pointer = this.input.activePointer;
        let closeToPlayer = false
        // Iterate through players and draw a circle if the mouse is close
        playersGroup.getChildren().forEach(player => {
            const distance = Phaser.Math.Distance.Between(player.x, player.y, pointer.x, pointer.y);

            // Define a threshold distance (adjust as needed)
            const thresholdDistance = 30;

            if (distance < thresholdDistance && selectionCheck(player)) {
                // Draw a circle around the player
                circleGraphics.lineStyle(2, 0xffffff); // Set circle color and width
                circleGraphics.strokeCircle(player.x, player.y, 30); // Draw a circle with a radius of 30
                line.x2 = player.x;
                line.y2 = player.y;
                lineGraphics.lineStyle(2, 0xffffff);
                lineGraphics.strokeLineShape(line);
                closeToPlayer = true;
            }
        });

        if( ! closeToPlayer && isInsideField(pointer.x, pointer.y)){
            line.x2 = pointer.x;
            line.y2 = pointer.y;
            lineGraphics.lineStyle(2, 0xffffff);
            lineGraphics.strokeLineShape(line);
        }
    }
</script>

</body>
</html>
